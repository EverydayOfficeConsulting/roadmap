<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOCO | The Blueprint</title>
    <style>
        /* IMPORT WIX-STYLE FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Cormorant+Garamond:wght@400;600&display=swap');

        :root { 
            /* THE "REMOTELY BALANCED" EARTH PALETTE */
            --primary-brand: #A39B8B;   /* Warm Taupe */
            --primary-dark: #5D5C61;    /* Charcoal Grey */
            --accent-soft: #E8E4E1;     /* Soft Beige */
            --bg-body: #F9F7F5;         /* Cream White */
            --bg-card: #FFFFFF;         /* Pure White */
            --text-main: #4A4A4A;       /* Soft Black */
            --text-muted: #8C8C8C;      /* Grey */
            --border-subtle: #EFEFEF;   /* Very light border */
            
            --radius-lg: 4px;           /* Slightly squarer for elegance */
            --radius-pill: 50px;
            --shadow-soft: 0 10px 40px -10px rgba(93, 92, 97, 0.1);
            --ease-lux: cubic-bezier(0.22, 1, 0.36, 1);
        }

        [data-theme="dark"] {
            --primary-brand: #C4BBAF;
            --primary-dark: #E0E0E0;
            --accent-soft: #2C2C2E;
            --bg-body: #1C1C1E; 
            --bg-card: #252527; 
            --text-main: #E0E0E0; 
            --text-muted: #999999; 
            --border-subtle: #333333;
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-body); 
            margin: 0; 
            overflow: hidden; 
            color: var(--text-main); 
            letter-spacing: 0.02em; /* Air out the text */
        }
        
        /* ELEGANT MINIMAL HEADER */
        header { 
            background: var(--bg-body); /* Blend with background */
            display: flex; flex-direction: column; align-items: center; 
            padding: 30px 20px 10px 20px; z-index: 4000; position: relative; 
        }
        .header-top { 
            display: flex; justify-content: space-between; align-items: center; 
            width: 100%; max-width: 900px; padding-bottom: 20px; 
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .brand-container { text-align: left; }
        .brand-name { 
            font-family: 'Cormorant Garamond', serif; /* Editorial Font */
            font-size: 1.8rem; font-weight: 600; letter-spacing: 0;
            color: var(--primary-dark); text-transform: lowercase; font-variant: small-caps;
        }
        .brand-slogan { 
            font-size: 0.65rem; font-weight: 500; text-transform: uppercase; 
            letter-spacing: 2px; color: var(--primary-brand); margin-top: 5px;
        }
        
        /* Minimal Text Toggle */
        .theme-toggle { 
            background: transparent; color: var(--primary-brand); border: 1px solid var(--primary-brand); 
            padding: 6px 16px; border-radius: var(--radius-pill); cursor: pointer; 
            font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s;
        }
        .theme-toggle:hover { background: var(--primary-brand); color: white; }

        .workspace { display: flex; height: calc(100vh - 110px); width: 100vw; position: relative; overflow: hidden; }
        
        /* FLOATING PANELS */
        .side-pane { 
            position: absolute; top: 0; bottom: 0; 
            background: var(--bg-card); 
            box-shadow: var(--shadow-soft);
            transition: transform 0.6s var(--ease-lux); 
            z-index: 3000; display: flex; flex-direction: column; padding: 40px; 
            border-right: 1px solid var(--border-subtle);
        }
        
        #pane-library { left: 0; transform: translateX(-100%); width: 45%; overflow-y: auto; }
        #pane-library.active { transform: translateX(0); }
        
        #pane-video { right: 0; transform: translateX(100%); width: 45%; border-left: 1px solid var(--border-subtle); border-right: none; }
        #pane-video.active { transform: translateX(0); }
        
        /* CENTER FEED */
        #pane-modules { 
            flex: 1; height: 100%; overflow-y: auto; padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: margin 0.6s var(--ease-lux); 
        }
        .workspace.lib-active #pane-modules { margin-left: 45%; }
        .workspace.vid-active #pane-modules { margin-right: 45%; }
        .workspace.both-active #pane-modules { margin-left: 33%; margin-right: 33%; }

        /* AESTHETIC CARDS */
        .phase-section { width: 100%; max-width: 650px; margin-bottom: 40px; }
        
        .phase-header { 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; padding: 10px 0; 
            border-bottom: 1px solid var(--primary-brand); /* Elegant underline */
            margin-bottom: 20px; transition: 0.3s; opacity: 0.7;
        }
        .phase-header:hover, .phase-section.open .phase-header { opacity: 1; }
        
        .phase-title-group { display: flex; align-items: center; gap: 15px; }
        
        .phase-icon { width: 12px; height: 12px; fill: var(--primary-dark); transition: 0.3s; }
        .phase-section.open .phase-icon { transform: rotate(90deg); }
        
        .phase-title { 
            font-family: 'Cormorant Garamond', serif; 
            font-size: 1.4rem; font-weight: 600; color: var(--primary-dark);
        }
        
        .phase-badge { 
            font-size: 0.6rem; padding: 4px 10px; border-radius: var(--radius-pill); 
            background: var(--accent-soft); color: var(--text-main); font-weight: 500; 
        }
        .phase-badge.complete { background: var(--primary-brand); color: white; }
        
        .phase-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s var(--ease-lux); }
        .phase-section.open .phase-content { grid-template-rows: 1fr; }
        .phase-inner { overflow: hidden; padding-top: 5px; }

        .module-card { 
            background: var(--bg-card); 
            padding: 40px; margin-bottom: 25px; 
            box-shadow: var(--shadow-soft);
            border: 1px solid white; /* Invisible border for spacing */
        }
        
        .module-title { 
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem; font-weight: 600; text-transform: uppercase; 
            margin-bottom: 10px; color: var(--primary-dark); letter-spacing: 1px;
        }
        .module-desc { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: var(--text-muted); margin-bottom: 30px; line-height: 1.4; font-style: italic; }
        
        .step-container { 
            border-top: 1px solid var(--border-subtle); 
            background: transparent; margin-bottom: 0; padding: 5px 0;
        }
        .step-container:last-child { border-bottom: 1px solid var(--border-subtle); }
        
        .step-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; cursor: pointer; }
        .step-name { font-weight: 500; font-size: 0.85rem; color: var(--text-main); }
        
        /* Minimal Checkbox */
        .step-header input { 
            appearance: none; width: 18px; height: 18px; 
            border: 1px solid var(--text-muted); border-radius: 50%; /* Circle Checkbox */
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .step-header input:checked { background: var(--primary-brand); border-color: var(--primary-brand); }

        .step-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease; }
        .step-container.open .step-content { grid-template-rows: 1fr; padding-bottom: 20px; }
        .content-inner { overflow: hidden; font-size: 0.85rem; color: var(--text-muted); line-height: 1.7; padding-left: 5px; }
        
        /* Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 20px; margin-top: 20px; }
        .tool-tile { 
            background: var(--bg-body); border-radius: 2px; 
            overflow: hidden; text-decoration: none; color: inherit; 
            transition: 0.3s; display: block; border: 1px solid transparent;
        }
        .tool-tile:hover { border-color: var(--primary-brand); }
        .tile-img { height: 90px; background-size: cover; background-position: center; opacity: 0.8; transition: 0.3s; grayscale(100%); }
        .tool-tile:hover .tile-img { opacity: 1; grayscale(0%); }
        .tile-name { padding: 15px; font-size: 0.7rem; font-weight: 500; text-align: center; color: var(--text-main); letter-spacing: 0.5px; }
        
        /* Buttons - Soft & Elegant */
        .btn-row { display: flex; gap: 20px; margin-top: 40px; }
        .action-btn, .close-btn { 
            flex: 1;
            background: var(--accent-soft); color: var(--text-main); 
            border: none; padding: 14px; 
            font-weight: 600; cursor: pointer; font-size: 0.75rem; 
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .action-btn:hover { background: var(--primary-brand); color: white; }
        
        /* Video */
        .video-wrapper { 
            position: relative; padding-bottom: 56.25%; height: 0; 
            background: #F0F0F0; border-radius: 2px; 
            overflow: hidden; margin-top: 20px;
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        /* Drawers */
        .lib-drawer { margin-bottom: 40px; }
        .lib-section-title { 
            font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; font-style: italic;
            color: var(--primary-brand); margin-bottom: 15px; border-bottom: 1px solid var(--accent-soft); padding-bottom: 5px;
        }

        @media (max-width: 768px) {
            .side-pane { width: 100% !important; left: 0 !important; right: 0 !important; bottom: 0 !important; top: 60px !important; transform: translateY(100%) !important; padding: 20px; }
            #pane-library.active, #pane-video.active { transform: translateY(0) !important; }
            .workspace.lib-active #pane-modules, .workspace.vid-active #pane-modules { margin: 0 !important; opacity: 0.2; pointer-events: none; }
        }
    </style>
</head>
<body data-theme="light">
<header>
    <div class="header-top">
        <div class="brand-container">
            <div class="brand-name">EOCO</div>
            <div class="brand-slogan">Foundational Roadmap</div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">Day / Night</button>
    </div>
</header>
<div class="workspace" id="main-ws">
    <section id="pane-library" class="side-pane">
        <button class="close-btn" style="margin-bottom:30px; background: transparent; border: 1px solid var(--text-muted);" onclick="toggleLibrary(null)">✕ Close Library</button>
        <div id="library-content"></div> 
    </section>
    
    <section id="pane-modules"><div id="module-list" style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top:20px;">Loading Roadmap...</div></section>
    
    <section id="pane-video" class="side-pane">
        <button class="close-btn" style="margin-bottom:20px; background: transparent; border: 1px solid var(--text-muted);" onclick="toggleVideo(null)">✕ Close Video</button>
        <div class="video-header">
            <div id="video-display-title" style="font-family:'Cormorant Garamond', serif; font-size:1.5rem; color:var(--primary-dark); margin-bottom:10px;">Tutorial</div>
        </div>
        <div class="video-wrapper" id="video-frame"></div>
        <button class="action-btn" style="margin-top:20px;" onclick="popOutVideo()">Open in New Window</button>
    </section>
</div>
<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRzaqh_1AJ24mk-Z8qlzxJOO-LhOtehDUu23m21b_OjbNuBkyA08ZUH_xEMH-9HUT-7l5ry5UsToEQT/pub?output=csv' + '&t=' + Date.now();
    let modules = [];
    const state = JSON.parse(localStorage.getItem('eoco_state')) || {};
    let activeLibId = null, currentVideoId = null;

    function toggleTheme() {
        const next = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', next); 
        localStorage.setItem('eoco_theme', next);
    }

    async function init() {
        const savedTheme = localStorage.getItem('eoco_theme') || 'light'; 
        document.body.setAttribute('data-theme', savedTheme);
        try {
            const res = await fetch(SHEET_URL); 
            const text = await res.text(); 
            const rows = parseCSV(text);
            let currentMod = null;
            
            rows.forEach(row => {
                const key = row[0]?.toString().trim().toUpperCase(); 
                const b = row[1]; 
                const c = row[2];
                
                if (key === 'ID') { 
                    if (currentMod) modules.push(currentMod); 
                    currentMod = { id: b, phase: 'PHASE 1', title: '', description: '', video: '', library: [], steps: [] }; 
                }
                if (!currentMod) return;
                
                if (key === 'PHASE') currentMod.phase = b || 'PHASE 1';
                if (key === 'TITLE') currentMod.title = b;
                if (key === 'DESCRIPTION') currentMod.description = b;
                if (key === 'VIDEO') currentMod.video = c;
                
                if (key === 'SECTION') {
                    currentMod.library.push({ title: b, items: [] });
                }
                if (key === 'TOOL') {
                    let lastSection = currentMod.library[currentMod.library.length - 1];
                    if (!lastSection) {
                        lastSection = { title: "Essentials", items: [] };
                        currentMod.library.push(lastSection);
                    }
                    lastSection.items.push({ name: b, url: c });
                }
                if (key === 'STEP') currentMod.steps.push({ name: b, tip: c });
            });
            
            if (currentMod) modules.push(currentMod); 
            render();
        } catch (e) { console.error(e); }
    }

    function parseCSV(t) {
        const re = /(?!\s*$)\s*(?:"([^"]*(?:""[^"]*)*)"|([^",\r\n]*))\s*(?:,|$)/g; 
        const res = [];
        t.split(/\r?\n/).forEach(l => { 
            const r = []; 
            l.replace(re, (m, p1, p2) => { 
                r.push(p1 !== undefined ? p1.replace(/""/g, '"') : p2); 
                return ''; 
            }); 
            if(r.length) res.push(r); 
        }); 
        return res;
    }

    function render() {
        const list = document.getElementById('module-list');
        const grouped = modules.reduce((acc, m) => { 
            if (!acc[m.phase]) acc[m.phase] = []; 
            acc[m.phase].push(m); 
            return acc; 
        }, {});

        list.innerHTML = Object.keys(grouped).map(phaseName => {
            let totalSteps = 0, completedSteps = 0;
            grouped[phaseName].forEach(m => { 
                totalSteps += m.steps.length; 
                completedSteps += (state[m.id] ? state[m.id].length : 0); 
            });
            const phaseId = `phase-${phaseName.replace(/[^a-zA-Z0-9]/g, '-')}`;

            return `
            <div class="phase-section open" id="${phaseId}">
                <div class="phase-header" onclick="this.parentElement.classList.toggle('open')" title="Toggle">
                    <div class="phase-title-group">
                        <svg class="phase-icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        <span class="phase-title">${phaseName}</span>
                    </div>
                    <span class="phase-badge ${completedSteps === totalSteps && totalSteps > 0 ? 'complete' : ''}">
                        ${completedSteps} / ${totalSteps}
                    </span>
                </div>
                <div class="phase-content">
                    <div class="phase-inner">
                        ${grouped[phaseName].map(m => `
                            <div class="module-card" id="mod-${m.id}">
                                <div class="module-title">${m.title}</div>
                                <div class="module-desc">${m.description || ''}</div>
                                ${m.steps.map((s, i) => `
                                    <div class="step-container">
                                        <div class="step-header" onclick="this.parentElement.classList.toggle('open')">
                                            <span class="step-name">${s.name}</span>
                                            <input type="checkbox" 
                                                id="chk-${m.id}-${i}"
                                                ${(state[m.id]?.includes(i)) ? 'checked' : ''} 
                                                onclick="event.stopPropagation(); toggleCheck('${m.id}', ${i}, '${phaseId}')">
                                        </div>
                                        <div class="step-content"><div class="content-inner">${s.tip}</div></div>
                                    </div>
                                `).join('')}
                                <div class="btn-row">
                                    <button class="action-btn" onclick="toggleLibrary('${m.id}')">
                                        Resources
                                    </button>
                                    <button class="action-btn" onclick="toggleVideo('${m.id}')">
                                        Watch Video
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleCheck(mid, idx, phaseId) {
        if (!state[mid]) state[mid] = [];
        const i = state[mid].indexOf(idx);
        if (i > -1) state[mid].splice(i, 1); 
        else state[mid].push(idx);
        localStorage.setItem('eoco_state', JSON.stringify(state));

        const phaseSection = document.getElementById(phaseId);
        if (phaseSection) {
            const total = phaseSection.querySelectorAll('input[type="checkbox"]').length;
            const checked = phaseSection.querySelectorAll('input[type="checkbox"]:checked').length;
            const badge = phaseSection.querySelector('.phase-badge');
            if (badge) {
                badge.innerText = `${checked} / ${total}`;
                if (checked === total && total > 0) badge.classList.add('complete');
                else badge.classList.remove('complete');
            }
        }
    }

    function updateLayoutClasses() {
        const ws = document.getElementById('main-ws');
        const libActive = document.getElementById('pane-library').classList.contains('active');
        const vidActive = document.getElementById('pane-video').classList.contains('active');
        ws.classList.remove('lib-active', 'vid-active', 'both-active');
        if (libActive && vidActive) ws.classList.add('both-active');
        else if (libActive) ws.classList.add('lib-active');
        else if (vidActive) ws.classList.add('vid-active');
    }

    function toggleLibrary(mid) {
        const p = document.getElementById('pane-library');
        const content = document.getElementById('library-content');
        
        if (!mid || (p.classList.contains('active') && activeLibId === mid)) { 
            p.classList.remove('active'); activeLibId = null; updateLayoutClasses(); return; 
        }
        
        const m = modules.find(mod => mod.id === mid);
        
        if (m.library && m.library.length > 0) {
            content.innerHTML = m.library.map((section) => {
                const grid = section.items.map(l => `
                    <a href="${l.url}" target="_blank" class="tool-tile">
                        <div class="tile-img" style="background-image: url('https://image.thum.io/get/width/400/crop/800/noanimate/${l.url}')"></div>
                        <div class="tile-name">${l.name}</div>
                    </a>`).join('');
                
                return `
                    <div class="lib-drawer">
                        <div class="lib-section-title">${section.title}</div>
                        <div class="gallery-grid">${grid}</div>
                    </div>
                `;
            }).join('');
        } else {
            content.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-muted); font-size:0.9rem;">No resources required.</div>';
        }
        
        p.classList.add('active'); activeLibId = mid; updateLayoutClasses();
    }

    function popOutVideo() {
        if (!currentVideoId) return;
        const width = 640; const height = 360;
        const left = (window.innerWidth / 2) - (width / 2); 
        const top = (window.innerHeight / 2) - (height / 2);
        window.open(`https://www.youtube.com/embed/${currentVideoId}?autoplay=1&cc_load_policy=1`, 'YouTubePopOut', `width=${width},height=${height},top=${top},left=${left},menubar=no,status=no,titlebar=no`);
        toggleVideo(null);
    }

    async function toggleVideo(mid) {
        const p = document.getElementById('pane-video'), f = document.getElementById('video-frame');
        const iframe = f.querySelector('iframe');
        const m = modules.find(mod => mod.id === mid);
        
        if (!mid || p.classList.contains('active')) {
            p.classList.remove('active'); updateLayoutClasses();
            if (iframe) iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            return;
        }
        
        let id = m.video.includes('v=') ? m.video.split('v=')[1]?.split('&')[0] : m.video.split('/').pop();
        try {
            const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`);
            const data = await response.json();
            document.getElementById('video-display-title').innerText = data.title || m.title;
        } catch (e) { document.getElementById('video-display-title').innerText = m.title; }
        
        if (currentVideoId !== id) {
            f.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1&cc_load_policy=1" allow="autoplay; fullscreen"></iframe>`;
            currentVideoId = id;
        } else if (iframe) iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        
        p.classList.add('active'); updateLayoutClasses();
    }

    init();
</script>
</body>
</html>
