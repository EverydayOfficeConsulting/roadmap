<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOCO | Simple. Better.</title>
    <style>
        :root { 
            /* THEME: STEEL & SLATE */
            --primary-brand: #3A506B;   
            --primary-dark: #1C2541;    
            --bg-main: #F0F4F8;         
            --bg-panel: #FFFFFF;        
            --text-main: #334155;       
            --text-muted: #64748B;      
            --border-grey: #D1D9E6;     
            --radius: 3px;              
            --shadow: 0 4px 12px rgba(58, 80, 107, 0.08); 
            --ease: cubic-bezier(0.2, 1, 0.3, 1);
        }

        [data-theme="dark"] {
            --bg-main: #0B1015; --bg-panel: #151B24; --border-grey: #2A3645;
            --text-main: #E2E8F0; --text-muted: #94A3B8; --primary-brand: #5C7C99;
            --primary-dark: #000000; --shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-main); margin: 0; overflow: hidden; color: var(--text-main); }
        
        /* HEADER */
        header { 
            background: var(--primary-dark); color: white; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 15px 20px 0 20px; z-index: 4000; position: relative; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-top { display: flex; justify-content: center; align-items: center; width: 100%; position: relative; padding-bottom: 15px; }
        .brand-container { text-align: center; }
        .brand-name { font-size: 1.2rem; font-weight: 800; letter-spacing: 4px; text-transform: uppercase; margin: 0; }
        .brand-slogan { font-size: 0.65rem; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: #8DA9C4; margin-top: 4px; }
        
        .page-title-section { background: rgba(255,255,255,0.05); width: 100vw; text-align: center; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); }
        .page-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: white; margin: 0; }

        .header-controls { display: flex; gap: 10px; align-items: center; position: absolute; right: 0; top: 0; }
        .theme-toggle, .profile-btn { 
            background: var(--primary-brand); color: white; border: 1px solid rgba(255,255,255,0.2); 
            padding: 6px 14px; border-radius: var(--radius); cursor: pointer; font-size: 0.6rem; font-weight: 700; 
            text-transform: uppercase; transition: background 0.2s;
        }

        .workspace { display: flex; height: calc(100vh - 125px); width: 100vw; position: relative; overflow: hidden; }
        
        /* PANELS */
        .side-pane { 
            position: absolute; top: 0; height: 100%; background: var(--bg-panel); border-color: var(--border-grey); 
            transition: transform 0.5s var(--ease); z-index: 3000; display: flex; flex-direction: column; padding: 25px; 
            box-shadow: var(--shadow); 
        }
        #pane-library { left: 0; border-right: 1px solid var(--border-grey); transform: translateX(-100%); width: 50%; overflow-y: auto; }
        #pane-library.active { transform: translateX(0); }
        #pane-video { right: 0; border-left: 1px solid var(--border-grey); transform: translateX(100%); width: 50%; }
        #pane-video.active { transform: translateX(0); }
        
        #pane-modules { flex: 1; height: 100%; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; transition: margin 0.5s var(--ease); }
        .workspace.lib-active #pane-modules { margin-left: 50%; }
        .workspace.vid-active #pane-modules { margin-right: 50%; }
        .workspace.both-active #pane-modules { margin-left: 33.33%; margin-right: 33.33%; }
        .workspace.both-active #pane-library, .workspace.both-active #pane-video { width: 33.33%; }

        /* PHASE & MODULE CARDS */
        .phase-section { width: 100%; max-width: 600px; margin-bottom: 30px; border-bottom: 1px solid var(--border-grey); }
        .phase-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px 0; user-select: none; }
        .phase-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary-brand); letter-spacing: 1.5px; }
        .phase-badge { font-size: 0.6rem; padding: 4px 10px; border-radius: var(--radius); background: var(--border-grey); color: var(--text-muted); font-weight: 600; }
        .phase-badge.complete { background: var(--primary-brand); color: white; }
        
        .module-card { background: var(--bg-panel); border-radius: var(--radius); padding: 35px; margin: 20px 0; border: 1px solid var(--border-grey); box-shadow: var(--shadow); }
        .module-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 8px; color: var(--text-main); }
        .module-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; line-height: 1.5; }

        .step-container { border: 1px solid var(--border-grey); border-radius: var(--radius); margin-bottom: 10px; background: var(--bg-panel); overflow: hidden; }
        .step-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; cursor: pointer; }
        .step-content { display: none; padding: 0 20px 20px 20px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.6; }
        .step-container.open .step-content { display: block; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .action-btn, .close-btn { background: var(--primary-brand); color: white; border: none; padding: 15px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; border-radius: var(--radius); }

        /* CLUSTER GROUP (All Canada Mode) */
        details.cluster-group { margin-top: 15px; border: 1px solid var(--border-grey); border-radius: var(--radius); overflow: hidden; }
        details.cluster-group summary { background: var(--bg-main); padding: 12px; cursor: pointer; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        
        /* MODAL */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(28, 37, 65, 0.9); z-index: 5000; display: none; justify-content: center; align-items: center; }
        #modal-overlay.active { display: flex; }
        .modal-card { background: var(--bg-panel); padding: 40px; border-radius: var(--radius); width: 90%; max-width: 500px; text-align: center; }
        .form-select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border-grey); border-radius: var(--radius); }
    </style>
</head>
<body data-theme="light">

<div id="modal-overlay">
    <div class="modal-card">
        <h2 style="color:var(--primary-brand);">Customize Roadmap</h2>
        <select id="user-province" class="form-select">
            <option value="CAN">All Canada</option>
            <option value="AB">Alberta</option><option value="BC">British Columbia</option>
            <option value="NS">Nova Scotia</option><option value="ON">Ontario</option>
        </select>
        <select id="user-industry" class="form-select">
            <option value="ALL">All Trades</option>
            <option value="Electrician">Electrician</option><option value="Plumber">Plumber</option>
            <option value="General">General Contractor</option>
        </select>
        <select id="user-software" class="form-select">
            <option value="QBO">QuickBooks</option><option value="XERO">Xero</option><option value="FRESHBOOKS">FreshBooks</option>
        </select>
        <button class="action-btn" style="width:100%;" onclick="saveProfile()">Build My Roadmap</button>
    </div>
</div>

<header>
    <div class="header-top">
        <div class="brand-container">
            <div class="brand-name">EOCO</div>
            <div class="brand-slogan">Simple Systems. Better Business.</div>
        </div>
        <div class="header-controls">
            <button class="profile-btn" onclick="openProfile()">Profile</button>
            <button class="theme-toggle" onclick="toggleTheme()">Mode</button>
        </div>
    </div>
    <div class="page-title-section"><h1 class="page-title">The Foundational Roadmap</h1></div>
</header>

<div class="workspace" id="main-ws">
    <section id="pane-library" class="side-pane">
        <button class="close-btn" onclick="toggleLibrary(null)">✕ CLOSE TOOLS</button>
        <div id="library-content"></div>
    </section>
    
    <section id="pane-modules"><div id="module-list">Syncing Roadmap...</div></section>

    <section id="pane-video" class="side-pane">
        <button class="close-btn" onclick="toggleVideo(null)">✕ CLOSE TUTORIAL</button>
        <div id="video-display-title" style="font-weight:800; margin:20px 0;">Tutorial</div>
        <div id="video-frame"></div>
    </section>
</div>

<script>
    // 1. UPDATE THIS URL WITH YOUR PUBLISHED GOOGLE SHEET CSV LINK
    const SHEET_URL = 'PASTE_YOUR_CSV_LINK_HERE';
    
    let modules = [];
    let state = JSON.parse(localStorage.getItem('eoco_state')) || {};
    let userProfile = JSON.parse(localStorage.getItem('eoco_profile'));

    function toggleTheme() {
        const next = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('eoco_theme', next);
    }

    function openProfile() { document.getElementById('modal-overlay').classList.add('active'); }

    function saveProfile() {
        userProfile = {
            province: document.getElementById('user-province').value,
            industry: document.getElementById('user-industry').value,
            software: document.getElementById('user-software').value
        };
        localStorage.setItem('eoco_profile', JSON.stringify(userProfile));
        document.getElementById('modal-overlay').classList.remove('active');
        init();
    }

    async function init() {
        if (!userProfile) { openProfile(); return; }
        try {
            const res = await fetch(SHEET_URL + '&t=' + Date.now());
            const text = await res.text();
            parseCSVData(text);
            render();
        } catch (e) { console.error("Sync Error:", e); }
    }

    function parseCSVData(text) {
        const rows = text.split(/\r?\n/).map(row => row.split(','));
        modules = [];
        let currentMod = null;

        rows.forEach(row => {
            const key = row[0]?.trim().toUpperCase();
            if (key === 'ID') {
                if (currentMod) modules.push(currentMod);
                currentMod = { id: row[1], phase: 'PHASE 1', title: '', desc: '', video: '', library: [], steps: [], tags: [] };
            }
            if (!currentMod) return;
            if (key === 'PHASE') currentMod.phase = row[1];
            if (key === 'TITLE') {
                const tagMatch = row[1].match(/\{([^}]+)\}/);
                currentMod.title = row[1].replace(/\{[^}]+\}/g, '').trim();
                if (tagMatch) currentMod.tags = tagMatch[1].split(',').map(t => t.trim().toUpperCase());
            }
            if (key === 'DESCRIPTION') currentMod.desc = row[1];
            if (key === 'STEP') currentMod.steps.push({ name: row[1], val: row[2] });
            if (key === 'TOOL') currentMod.library.push({ name: row[1], val: row[2] });
            if (key === 'VIDEO') currentMod.video = row[2];
        });
        if (currentMod) modules.push(currentMod);
    }

    function isVisible(m) {
        if (!m.tags || m.tags.length === 0) return true;
        const s = userProfile.software.toUpperCase();
        return m.tags.includes(s);
    }

    function render() {
        const list = document.getElementById('module-list');
        list.innerHTML = modules.filter(isVisible).map(m => `
            <div class="module-card">
                <div class="module-title">${m.title}</div>
                <div class="module-desc">${m.desc}</div>
                ${m.steps.map(s => `
                    <div class="step-container" onclick="this.classList.toggle('open')">
                        <div class="step-header"><span class="step-name">${s.name}</span></div>
                        <div class="step-content">${s.val}</div>
                    </div>
                `).join('')}
                <div class="btn-row">
                    <button class="action-btn" onclick="toggleLibrary('${m.id}')">Links & Tools</button>
                    <button class="action-btn" onclick="toggleVideo('${m.id}')">Watch Video</button>
                </div>
            </div>
        `).join('');
    }

    function toggleLibrary(id) {
        const p = document.getElementById('pane-library');
        if (!id) { p.classList.remove('active'); return; }
        const m = modules.find(mod => mod.id === id);
        document.getElementById('library-content').innerHTML = `<h3>${m.title} Tools</h3>` + 
            m.library.map(l => `<a href="${l.val}" target="_blank" class="action-btn" style="display:block; margin-bottom:10px; text-decoration:none; text-align:center;">${l.name}</a>`).join('');
        p.classList.add('active');
        updateLayout();
    }

    function toggleVideo(id) {
        const p = document.getElementById('pane-video');
        if (!id) { p.classList.remove('active'); return; }
        const m = modules.find(mod => mod.id === id);
        const vidId = m.video.split('v=')[1]?.split('&')[0];
        document.getElementById('video-frame').innerHTML = `<iframe width="100%" height="300" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>`;
        p.classList.add('active');
        updateLayout();
    }

    function updateLayout() {
        const ws = document.getElementById('main-ws');
        const lib = document.getElementById('pane-library').classList.contains('active');
        const vid = document.getElementById('pane-video').classList.contains('active');
        ws.className = 'workspace' + (lib ? ' lib-active' : '') + (vid ? ' vid-active' : '') + (lib && vid ? ' both-active' : '');
    }

    init();
</script>
</body>
</html>
